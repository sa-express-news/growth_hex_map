<html lang="en">
    <title>Hex Map Appraisal District Data--Growth Project</title>

    <head>
        <link rel="stylesheet" href="css/leaflet.css" />
        <link rel="stylesheet" href="css/styles.css" />
        <script src="js/leaflet.js"></script>
        <script src="js/jquery-1.11.1.js"></script>
        <script src="js/leaflet.utfgrid.js"></script>
        <script src="js/highcharts.js"></script>
        <script src="js/houses_built_by_year.js"></script>
    </head>

    <body>

    <div id="mapcontainer">
            <div id="map"></div>
            <div id="hover"></div>
            <div id="highcharts_container">
            </div>
    </div>

    <script>
        var hex_layer = L.tileLayer('http://localhost:3333/data/11_5/tiles/{z}/{x}/{y}.png');
        var utfgrid = new L.UtfGrid('http://localhost:3333/data/11_5/tiles/{z}/{x}/{y}.grid.json', { useJsonP: false });
        var options = {};

        var map = L.map('map', {scrollWheelZoom: false}).setView([29.463533, -99.093827], 10);

        function style(feature) {
            return {
                weight: 2,
                opacity: 1,
                color: "#ff6600",
                fillOpacity: 0.4
            };
        }

        map.addLayer(hex_layer);
        map.addLayer(utfgrid);

        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: '\'FarnhamText\', serif'
                }
            },
            title: {
                text: 'Age of San Antonio Housing by Year 1940 - 2014'
            },
            subtitle: {
                text: 'Bexar County Appraisal Office'
            },
            legend: {
                enabled: false
            },
            tooltip: {
                crosshairs: [{
                    width: 1.5,
                    dashStyle: 'solid',
                    color: 'black'
                }, false]
            }, 
            plotOptions: {
                line: {
                    marker: {
                        enabled: false
                    }
                }
            },
            series: {
                marker: {
                    enabled: false
                }
            },
            xAxis: {
                minorTickLength: 0,
                tickLength: 0,
                tickInterval: 10
            },
            yAxis: {
                title: {
                    text: 'Number of homes built',
                    style: {
                        fontSize:"130%",
                        letterSpacing:'.5px'
                    }
                },
                min: 0,
            }
        });

        $(function () {
            var len = houses_built_by_year[0].data.length;
            i = 0;

            options = {
                chart: {
                    renderTo: 'highcharts_container',
                    type: 'line'
                }, 
            xAxis: {
                categories: []
            }, 
            series: []
            }

            for(i; i < len ; i++) {
                options.xAxis.categories.push(houses_built_by_year[0].data[i]);
            }

            options.series.push(houses_built_by_year[1]);



            $('#highcharts_container').highcharts(options);
            var chart = $('#highcharts_container').highcharts();

            utfgrid.on('mouseover', function (e) {
                function makeLine(year) {
                    //console.log(year);
                    chart.xAxis[0].addPlotLine({
                    value: year,
                    color: 'gray',
                    width: 2,
                    id: 'plot-line'
                    });
                
                }

                function findIndex(value) {
                    for(var i = 0; i < options.xAxis.categories.length; i += 1) {
                        if (options.xAxis.categories[i] === value){
                            console.log(i);
                            return i;
                        }
                    }
                }

                if (e.data) {
                    //console.log(e.data);
                    document.getElementById('hover').innerHTML = 'hover: ' + e.data.avg_year_built;
                        makeLine(findIndex(Math.floor(e.data.avg_year_built)));
                } else {
                    document.getElementById('hover').innerHTML = 'hover: nothing';
                }


            });

            utfgrid.on('mouseout', function(e) {
                console.log('unhover: ' + e.data.avg_year_built )
                chart.xAxis[0].removePlotLine('plot-line');
            });

        });
    </script>        


    </body>

</html>